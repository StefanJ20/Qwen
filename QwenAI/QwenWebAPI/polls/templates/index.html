<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)']],
      displayMath: [['\\[', '\\]']]
    }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <meta charset="UTF-8" />
  <title>Martin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #020617;
      --panel: #111827;
      --border: #233444;
      --text: #caccd1;
      --muted: #9ca3af;
      --accent: #a33865;
      --guide: rgb(117, 16, 92);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      height: 100vh;
      overflow-y: hidden;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .guide {
      position: fixed;
      top: 0;
      height: 96vh;
      width: 2px;
      background: var(--guide);
      z-index: 0;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6), inset 0 0 0 1px rgba(255,255,255,0.02);
    }

    .guide { 

        right: 8.15in; 
        margin-top: 15px;
        margin-bottom: 50px;
    
    }

    .topbar {
      position: fixed;
      top: 0;
      left: 11.7in;
      right: 0.6in;
      height: 56px;
      background: var(--panel);
      border: 3px solid var(--border);
      border-radius: 14px;
      margin-top: 8px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      z-index: 3;

      transform: translateY(0);
      transition: transform 200ms ease;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6), inset 0 0 0 1px rgba(255,255,255,0.02);
    }

    .topbar.hidden {
      transform: translateY(calc(-100% - 16px));
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .brand {
      font-weight: 700;
      letter-spacing: 0.2px;
      color: var(--text);
      white-space: nowrap;
    }

    .topbar-nav {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: nowrap;
      overflow: hidden;
    }

    .topbar-nav button,
    .topbar-nav select {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.85rem;
      outline: none;
    }

    .topbar-nav button:hover,
    .topbar-nav select:hover {
      color: var(--text);
      border-color: var(--accent);
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .topbar-toggle {
      position: fixed;
      top: 15px;
      right: 0.3in;
      transform: translateX(50%);
      z-index: 4;
      background: var(--panel);
      border: 2px solid var(--border);
      border-radius: 999px;
      width: 36px;
      height: 36px;
      display: grid;
      place-items: center;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6), inset 0 0 0 1px rgba(255,255,255,0.02);
      transition: border-color 150ms ease;
      user-select: none;
    }

    .topbar-toggle:hover {
      border-color: var(--accent);
    }

    .topbar-toggle span {
      display: inline-block;
      color: var(--muted);
      font-size: 18px;
      line-height: 1;
      transition: transform 200ms ease;
    }

    .topbar-toggle.hidden span {
      transform: rotate(180deg);
    }

    main {
      height: 100%;
      display: grid;
      place-items: center;
      color: var(--muted);
      font-size: 1.1rem;
      padding-top: 70px; 
    }

    .editor-wrapper {
      display: flex;
      flex-direction: column;
      position: fixed;
      width: 37%;
      height: 22vh;
      bottom: 24px;
      left: 12in;
      background: var(--panel);
      border: 2px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6), inset 0 0 0 1px rgba(255,255,255,0.02);
      z-index: 2;
    }

    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex: 0 0 auto;
      margin-bottom: 10px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .editor-header button {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 4px 10px;
      border-radius: 8px;
      cursor: pointer;
    }

    .editor-header button:hover {
      color: var(--text);
      border-color: var(--accent);
    }

    textarea {
      flex: 1 1 auto;
      min-height: 0;
      width: 100%;
      resize: none;
      background: #020617;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      font-size: 0.95rem;
      line-height: 1.5;
      outline: none;
    }

    textarea::placeholder { color: #6b7280; }

    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }

    .userInputBox {
      position: fixed;
      bottom: 10px;
      left: 11.75in;
      right: 0.1in;
      height: 25vh;
      background: #5b3c74;
      border: 4px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6), inset 0 0 0 1px rgba(255,255,255,0.02);
      display: flex;
      flex-direction: column;
      z-index: 2;
    }

    .responseContent {
      position: fixed;
      height: 98.5vh;
      top: 5px;
      flex: 1 1 auto;
      overflow-y: auto;
      color: var(--text);
      font-size: 1rem;
      background-color: rgb(25, 2, 27);
      padding: 10px;
      border-radius: 8px;
      line-height: 1.5;
      left: 0.1in;
      right: 8.5in;
      border: 4px solid var(--border);
      box-shadow: 0 10px 30px rgba(0,0,0,0.6), inset 0 0 0 1px rgba(255,255,255,0.02);
    }

    .responseContent {
        scrollbar-width: none;  
        -ms-overflow-style: none;  
    }

    .responseContent::-webkit-scrollbar {
        display: none;         
    }


    .responseContent {
        overflow-wrap: anywhere;
        word-break: break-word;
    }

    .responseContent p {
        margin: 0.6rem 0;
    }

    .responseContent h1, .responseContent h2, .responseContent h3,
    .responseContent h4, .responseContent h5, .responseContent h6 {
        margin: 1rem 0 0.5rem;
    }

    .responseContent ul,
    .responseContent ol {
        margin: 0.6rem 0;
        padding-left: 1.4rem;  
    }

    .responseContent li {
        margin: 0.25rem 0;
    }

    .responseContent ul ul,
    .responseContent ol ol,
    .responseContent ul ol,
    .responseContent ol ul {
        margin: 0.25rem 0;
        padding-left: 1.2rem;   
    }
    
    .msg {
        max-width: 85%;
        width: fit-content;
        padding: 10px 14px;
        margin: 8px 0;
        border-radius: 18px;
        border: 2px solid var(--border);
        line-height: 1.45;
        word-wrap: break-word;
        box-shadow:
          0 1px 1px rgba(0,0,0,0.15),
          inset 0 0 0 1px rgba(255,255,255,0.04);
    }

    .msg-meta {
      font-size: 0.7rem;
      opacity: 0.65;
      margin-bottom: 4px;
      user-select: none;
    }

    .msg.user {
      margin-left: auto;
      background-color: rgb(25, 2, 27);
      color: #ffffff;
      border-bottom-right-radius: 6px;
    }

    .msg.user::after {
      content: "";
      position: absolute;
      right: -6px;
      bottom: 8px;
      width: 10px;
      height: 10px;
      background: #006edc;
      border-bottom-left-radius: 10px;
      transform: rotate(45deg);
    }

    .msg.assistant {
      margin-right: auto;
      margin-left: 2px;
      background: linear-gradient(
        180deg,
        #2c2f36,
        #1f2228
      );
      color: var(--text);
      border-bottom-left-radius: 6px;
    }

    .msg.assistant::after {
      content: "";
      position: absolute;
      left: -6px;
      bottom: 8px;
      width: 10px;
      height: 10px;
      background: #1f2228;
      border-bottom-right-radius: 10px;
      transform: rotate(45deg);
    }

    .msg-body > :first-child { margin-top: 0; }
    .msg-body > :last-child { margin-bottom: 0; }

    .msg-body p {
      margin: 0.45em 0;
    }

    .msg-body {
        white-space: normal;
        word-break: break-word;
        overflow-wrap: break-word;
    }

    .msg-body pre {
      background: rgba(0,0,0,0.25);
      max-width: 100%;
      white-space: pre-wrap;
      word-break: break-word;
      padding: 10px;
      border-radius: 12px;
      overflow-x: auto;
    }

    .msg-body code {
      background: rgba(0,0,0,0.25);
      padding: 2px 6px;
      max-width: 100%;
      white-space: pre-wrap;
      word-break: break-word;
      border-radius: 6px;
      font-size: 0.9em;
    }

    .responseContent.empty {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      color: var(--muted);
    }

  </style>
</head>

<body>
  <div class="guide"></div>

  <header class="topbar" id="topbar">
    <div class="topbar-left">
      <div class="brand">Qwen</div>
      <nav class="topbar-nav" aria-label="Header options">
        <button type="button">New Chat</button>
        <button type="button">Tools</button>
        <button type="button">Files</button>
        <select>
          <option>Qwen2.5-7B</option>
          <option>Qwen2.5-14B</option>
        </select>
      </nav>
    </div>

    <div class="topbar-right">
      <button type="button" style="background:transparent;border:1px solid var(--border);color:var(--muted);padding:6px 10px;border-radius:10px;cursor:pointer;">
        Settings
      </button>
    </div>
  </header>

  <button class="topbar-toggle" id="topbarToggle" type="button" aria-label="Toggle header">
    <span>â–´</span>
  </button>

  <main>
    <div class="responseContent empty">Martin's response will appear here.</div>
  </main>

  <div class="userInputBox">
    <div class="editor-wrapper">
      <div class="editor-header">
        <span>Editor</span>
        <span id="thinking" style="opacity: 0;">Martin is Thinking...</span>
        <button type="button" id="sendButton">Send</button>
      </div>

      <textarea placeholder="Type here..." id="userInput"></textarea>
    </div>
  </div>
</body>

<script>
    let history = [];
    document.addEventListener("DOMContentLoaded", () => {

        function protectMathOutsideCode(md) {
            const blocks = [];
            const inlines = [];
            const parts = md.split(/(```[\s\S]*?```)/g);

            for (let i = 0; i < parts.length; i++) {
                const part = parts[i];
                if (part.startsWith("```")) continue;
                parts[i] = parts[i].replace(/\\{1,2}\[[\s\S]*?\\{1,2}\]/g, (m) => {
                    const key = `@@MATH_BLOCK_${blocks.length}@@`;
                    blocks.push(m.replace(/\\{2}\[/g, "\\[").replace(/\\{2}\]/g, "\\]"));
                    return key;
                });
                parts[i] = parts[i].replace(/\\{1,2}\([\s\S]*?\\{1,2}\)/g, (m) => {
                    const key = `@@MATH_INLINE_${inlines.length}@@`;
                    inlines.push(m.replace(/\\{2}\(/g, "\\(").replace(/\\{2}\)/g, "\\)"));
                    return key;
                });
            }
            return { src: parts.join(""), blocks, inlines };
        }
  
        function restoreMath(html, blocks, inlines) {
            for (let i = 0; i < blocks.length; i++) {
                const key = `@@MATH_BLOCK_${i}@@`;
                html = html.split(key).join(blocks[i]);
            }
            for (let i = 0; i < inlines.length; i++) {
                const key = `@@MATH_INLINE_${i}@@`;
                html = html.split(key).join(inlines[i]);
            }
            return html;
        }

        function normalizeTexDelimiters(md) {
            return md
                .replace(/\\\\\[/g, "\\[")
                .replace(/\\\\\]/g, "\\]")
                .replace(/\\\\\(/g, "\\(")
                .replace(/\\\\\)/g, "\\)");
        }

        function escapeHTML(s) {
          return s
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
        }

        function roleLabel(role) {
          return role === "user" ? "You" : "Martin";
        }


        function renderMarkdown(history) {
            marked.setOptions({ mangle: false, headerIds: false });
            const combinedMd = history.map((m) => {
                const role = m.role === "user" ? "user" : "assistant";
                return `<div class="msg ${role}">
                        <div class="msg-meta">${roleLabel(m.role)}</div>
                        <div class="msg-body">
                        ${m.content}
                        </div></div>`;
            }).join("\n\n");
            let md = normalizeTexDelimiters(combinedMd);
            md = md.replace(/^\s{4,}(\\\[|\\\(|\\begin\{)/gm, "$1");
        
            const { src, blocks, inlines } = protectMathOutsideCode(md);
        
            let html = marked.parse(src);
            html = restoreMath(html, blocks, inlines);
        
            responseContent.innerHTML = DOMPurify.sanitize(html);
        
            if (window.MathJax?.typesetPromise) {
                MathJax.typesetClear([responseContent]);
                MathJax.typesetPromise([responseContent]);
            }
            responseContent.scrollTop = responseContent.scrollHeight;
        }

        function renderText(history) {
            const html = history.map((m) => {
                const role = m.role === "user" ? "user" : "assistant";
                return `<div class="msg ${role}">
                        <div class="msg-meta">${roleLabel(m.role)}</div>
                        <pre class="msg-body" style="white-space:pre-wrap;margin:0;">
                        ${escapeHTML(m.content)}
                        </pre></div>`;
            }).join("");

            responseContent.innerHTML = DOMPurify.sanitize(html);
            responseContent.scrollTop = responseContent.scrollHeight;
        }
      
        let thinking = false;
        const CHAT_API_URL = "{% url 'chat_api' %}";
        const topbar = document.getElementById("topbar");
        const toggle = document.getElementById("topbarToggle");
        const responseContent = document.querySelector(".responseContent");
        const sendButton = document.getElementById("sendButton");
        const textInput = document.getElementById("userInput");
        const thinkingIndicator = document.getElementById("thinking");
      
        function setHidden(isHidden) {
            topbar.classList.toggle("hidden", isHidden);
            toggle.classList.toggle("hidden", isHidden);
        }
      
        setHidden(false);
        toggle.addEventListener("click", () => {
            setHidden(!topbar.classList.contains("hidden"));
        });
      
        sendButton.addEventListener("click", async () => {
            if (thinking) return;
            const userText = textInput.value.trim();
            if (!userText) return;
            textInput.value = "";
            thinking = true;
            thinkingIndicator.style.opacity = 1;
            history.push({ role: "user", content: userText });
            try {
                const res = await fetch(CHAT_API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ history, max_new_tokens: 2000 })
                });
              
                if (!res.ok) {
                    responseContent.textContent = `Server error (${res.status}): ${await res.text()}`;
                    return;
                }
                const data = await res.json();
                const s = data.content;
                responseContent.classList.remove("empty");
                history.push({ role: "assistant", content: s });
                if (data.format === "markdown") renderMarkdown(history);
                else renderText(history);
            } catch (e) {
                responseContent.textContent = `Fetch failed: ${e}`;
            } finally {
                thinkingIndicator.style.opacity = 0;
                thinking = false;
            }
        });
    });
</script>
</html>
